name: Apigee X CI/CD for KVMs, Target Servers, Shared flows and API Proxies

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/1041995087153/locations/global/workloadIdentityPools/github-pool/providers/github
          service_account: apigee-deploy-sa@bamboo-zone-363116.iam.gserviceaccount.com

      - name: Install apigeecli
        run: |
          curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh -o install_apigeecli.sh
          if [ -s install_apigeecli.sh ]; then
            chmod +x install_apigeecli.sh
            ./install_apigeecli.sh
            echo "$HOME/.apigeecli/bin" >> $GITHUB_PATH
            echo "‚úÖ apigeecli installed successfully."
          else
            echo "‚ùå Error: apigeecli installer download failed."
            exit 1
          fi

      - name: Deploy KVMs
        run: |
          if [ -d "configs/kvms" ] && [ "$(ls -A configs/kvms/*.json 2>/dev/null)" ]; then
            for file in configs/kvms/*.json; do
              KVM_NAME=$(basename "$file" .json)
              echo "Processing KVM: $KVM_NAME"
              apigeecli kvms create --org ${{ secrets.APIGEE_ORG }} --env ${{ secrets.APIGEE_ENV }} \
                --name "$KVM_NAME" --default-token || true
              apigeecli kvms entries import --org ${{ secrets.APIGEE_ORG }} --env ${{ secrets.APIGEE_ENV }} \
                --map "$KVM_NAME" -f "$file" --default-token
              echo "‚úÖ KVM '$KVM_NAME' synced successfully."
            done
          else
            echo "‚ÑπÔ∏è No KVM configurations found to deploy."
          fi

      - name: Deploy Modified Target Servers
        run: |
          MODIFIED_TS=$(git diff --name-only HEAD^ HEAD | grep '^configs/target-servers/' | sort -u || true)
          if [ -n "$MODIFIED_TS" ]; then
            for file in $MODIFIED_TS; do
              if [ -f "$file" ]; then
                TS_NAME=$(basename "$file" .json)
                echo "üöÄ Syncing Modified Target Server: $TS_NAME"
                apigeecli targetservers import --org ${{ secrets.APIGEE_ORG }} --env ${{ secrets.APIGEE_ENV }} \
                  -f "$file" --default-token
                echo "‚úÖ Target Server '$TS_NAME' deployed successfully."
              fi
            done
          else
            echo "‚ÑπÔ∏è No Target Servers modified in this commit."
          fi
      - name: Deploy Modified Caches
        run: |
          MODIFIED_CACHES=$(git diff --name-only HEAD^ HEAD | grep '^configs/caches/' | sort -u || true)
          if [ -n "$MODIFIED_CACHES" ]; then
            for file in $MODIFIED_CACHES; do
              if [ -f "$file" ]; then
                CACHE_NAME=$(basename "$file" .json)
                echo "üöÄ Syncing Modified Cache: $CACHE_NAME"

                # Use JQ to parse the JSON file content into variables
                # Assumes the JSON format you provided previously (array of one object)
                TIMEOUT=$(jq -r '.[0].expirySettings.timeoutInSec.value' "$file")
                DESC=$(jq -r '.[0].description' "$file")
                
                # Try to create the cache first. If it fails (already exists), then update it.
                # Note: 'create' only accepts flags, not a file input.
                # apigeecli environments caches create \
                #   --name "$CACHE_NAME" \
                #   --org "${{ secrets.APIGEE_ORG }}" \
                #   --env "${{ secrets.APIGEE_ENV }}" \
                #   --desc "$DESC" \
                #   --default-token
                 
                  apigeecli environments caches create --help
                
                echo "‚úÖ Cache '$CACHE_NAME' deployed successfully."
              fi
            done
          else
            echo "‚ÑπÔ∏è No Cache configurations modified in this commit."
          fi

      
      # üü¢ Cache Verification Step
      - name: Verify Deployed Caches
        run: apigeecli cache list --org ${{ secrets.APIGEE_ORG }} --env ${{ secrets.APIGEE_ENV }} --default-token    

      - name: Deploy Modified Shared Flows
        run: |
          MODIFIED_SFS=$(git diff --name-only HEAD^ HEAD | grep '^sharedflows/' | cut -d/ -f2 | sort -u || true)
          if [ -n "$MODIFIED_SFS" ]; then
            for SF_NAME in $MODIFIED_SFS; do
              if [ -d "sharedflows/$SF_NAME/sharedflowbundle" ]; then
                echo "üöÄ Creating and Deploying Shared Flow: $SF_NAME"
                apigeecli sharedflows create bundle --name "$SF_NAME" \
                  --sf-folder "sharedflows/$SF_NAME/sharedflowbundle" \
                  --org ${{ secrets.APIGEE_ORG }} --default-token
                apigeecli sharedflows deploy --name "$SF_NAME" --org ${{ secrets.APIGEE_ORG }} \
                  --env ${{ secrets.APIGEE_ENV }} --ovr --default-token
                echo "‚úÖ Shared Flow '$SF_NAME' deployed successfully."
              fi
            done
          else
            echo "‚ÑπÔ∏è No Shared Flows modified in this commit."
          fi

      - name: Deploy Modified API Proxies
        run: |
          MODIFIED_PROXIES=$(git diff --name-only HEAD^ HEAD | grep '^proxies/' | cut -d/ -f2 | sort -u || true)
          if [ -n "$MODIFIED_PROXIES" ]; then
            for PROXY_NAME in $MODIFIED_PROXIES; do
              if [ -d "proxies/$PROXY_NAME/apiproxy" ]; then
                echo "üöÄ Creating and Deploying Proxy: $PROXY_NAME"
                apigeecli apis create bundle --name "$PROXY_NAME" \
                  --proxy-folder "proxies/$PROXY_NAME/apiproxy" \
                  --org ${{ secrets.APIGEE_ORG }} --default-token
                apigeecli apis deploy --name "$PROXY_NAME" --org ${{ secrets.APIGEE_ORG }} \
                  --env ${{ secrets.APIGEE_ENV }} --ovr --default-token
                echo "‚úÖ API Proxy '$PROXY_NAME' deployed successfully."
              fi
            done
          else
            echo "‚ÑπÔ∏è No API Proxies modified in this commit."
          fi
name: Apigee X CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Authenticate to GCP
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_APIGEE_SA_KEY }}

      # 3️⃣ Install apigeecli
      - name: Install apigeecli
        run: |
          curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh | sh
          echo "$HOME/.apigeecli/bin" >> $GITHUB_PATH

      # 4️⃣ Verify apigeecli (runs in separate step so $GITHUB_PATH is effective)
      - name: Verify apigeecli
        run: |
          which apigeecli
          apigeecli --help

      # 5️⃣ Fetch full Git history (to compare changes correctly)
      - name: Fetch full Git history
        run: |
          git fetch --prune --unshallow

      # 6️⃣ Check for changes in proxy folders (and get modified proxies)
      - name: Check for changed proxies
        id: check_changes
        run: |
          # Get list of modified directories in 'proxies/' folder
          modified_proxies=$(git diff --name-only origin/main...HEAD | grep -E '^proxies/.*' | cut -d'/' -f2 | sort | uniq)

          # Output the list of modified proxies
          echo "Modified proxies: $modified_proxies"
          
          # Save the modified proxies list to GitHub environment for later steps
          echo "modified_proxies=$modified_proxies" >> $GITHUB_ENV

      # 7️⃣ Prepare and Import Apigee Proxy ZIPs for the modified proxies
      - name: Prepare and Import Apigee Proxy ZIPs
        run: |
          mkdir -p apigee-bundles
          
          # Loop through the modified proxies and zip + import each one
          for api_name in ${{ env.modified_proxies }}; do
            echo "Processing modified API proxy: $api_name"
            
            if [ -d "proxies/$api_name/apiproxy" ]; then
              # Zip the API proxy into apigee-bundles folder
              zip_file="apigee-bundles/${api_name}.zip"
              cd "proxies/$api_name"
              zip -r "../../$zip_file" apiproxy
              cd ../..

              # Verify the file exists
              if [ -f "$zip_file" ]; then
                echo "Importing $api_name ..."
                apigeecli apis import \
                  -f "${GITHUB_WORKSPACE}/apigee-bundles" \
                  --org ${{ secrets.APIGEE_ORG }} \
                  --default-token
              else
                echo "Error: $zip_file not found!"
              fi
            fi
          done

      # 8️⃣ Deploy latest revision for the modified proxies
      - name: Deploy latest revision for modified proxies
        run: |
          # Loop through each modified proxy and deploy
          for api_name in ${{ env.modified_proxies }}; do
            echo "Deploying $api_name ..."
            apigeecli apis deploy \
              --org ${{ secrets.APIGEE_ORG }} \
              --env ${{ secrets.APIGEE_ENV }} \
              --name "$api_name" \
              --ovr \
              --default-token
          done

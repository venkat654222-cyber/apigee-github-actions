name: Apigee X CI/CD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Authenticate to GCP
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_APIGEE_SA_KEY }}

      # 3️⃣ Install apigeecli
      - name: Install apigeecli
        run: |
          curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh | sh
          echo "$HOME/.apigeecli/bin" >> $GITHUB_PATH

      # 4️⃣ Verify apigeecli
      - name: Verify apigeecli
        run: |
          which apigeecli
          apigeecli --help

      # 5️⃣ Detect changed proxies
      - name: Determine changed proxies
        id: changed
        run: |
          # Detect folders changed under proxies/
          echo "CHANGED_PROXIES=$(git diff --name-only ${{ github.sha }} ${{ github.event.before }} | grep '^proxies/' | cut -d/ -f2 | sort -u | tr '\n' ' ')" >> $GITHUB_ENV
          echo "Changed proxies: $CHANGED_PROXIES"

      # 6️⃣ Deploy only changed proxies
      - name: Deploy changed proxies
        run: |
          mkdir -p apigee-bundles
          for proxy in $CHANGED_PROXIES; do
            echo "Processing proxy: $proxy"

            # Zip the proxy bundle
            cd proxies/$proxy
            zip -r ../../../apigee-bundles/$proxy.zip apiproxy
            cd ../..

            # Import the proxy
            apigeecli apis import \
              -f apigee-bundles/$proxy.zip \
              --org ${{ secrets.APIGEE_ORG }} \
              --default-token

            # Deploy the latest revision
            apigeecli apis deploy \
              --org ${{ secrets.APIGEE_ORG }} \
              --env ${{ secrets.APIGEE_ENV }} \
              --name $proxy \
              --ovr \
              --default-token

            echo "Deployment complete for proxy: $proxy"
          done

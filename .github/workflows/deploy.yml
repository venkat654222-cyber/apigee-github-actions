name: Apigee X CI/CD - Deploy Multiple APIs

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Authenticate to GCP
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_APIGEE_SA_KEY }}

      # 3️⃣ Install apigeecli
      - name: Install apigeecli
        run: |
          curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh | sh
          echo "$HOME/.apigeecli/bin" >> $GITHUB_PATH

      # 4️⃣ Verify apigeecli
      - name: Verify apigeecli
        run: |
          which apigeecli
          apigeecli --help

      # 5️⃣ Deploy all APIs in proxies/
      - name: Deploy all API proxies
        run: |
          mkdir -p apigee-bundles

          for api in proxies/*; do
            if [ -d "$api/apiproxy" ]; then
              api_name=$(basename $api)
              echo "Processing API proxy: $api_name"

              # Zip the API proxy
              zip_file="apigee-bundles/${api_name}.zip"
              cd "$api"
              zip -r "../../$zip_file" apiproxy
              cd ../..

              # Import the API proxy
              echo "Importing $api_name ..."
              apigeecli apis import \
                -f "$zip_file" \
                --org ${{ secrets.APIGEE_ORG }} \
                --default-token

              # Deploy the latest revision
              echo "Deploying $api_name ..."
              apigeecli apis deploy \
                --org ${{ secrets.APIGEE_ORG }} \
                --env ${{ secrets.APIGEE_ENV }} \
                --name "$api_name" \
                --ovr \
                --default-token
            fi
          done

name: Deploy Apigee Proxy

on:
  push:
    branches:
      - main  # Change to your branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      APIGEE_ORG: ${{ secrets.APIGEE_ORG }}
      APIGEE_ENV: ${{ secrets.APIGEE_ENV }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up apigeecli
        run: |
          curl -L https://github.com/apigee/apigeecli/releases/download/v2.16.0/apigeecli_linux_amd64.zip -o apigeecli.zip
          unzip apigeecli.zip
          chmod +x apigeecli
          sudo mv apigeecli /usr/local/bin/apigeecli
          apigeecli version

      - name: Zip API Proxy
        run: |
          cd proxies/hello-world
          zip -r hello-world.zip apiproxy
          ls -l hello-world.zip

      - name: Import API Proxy
        run: |
          apigeecli apis import \
            --org ${{ secrets.APIGEE_ORG }} \
            -f proxies/hello-world/hello-world.zip \
            --default-token \
            --no-warnings

      - name: Verify import
        run: |
          echo "APIs in org:"
          apigeecli apis list --org ${{ secrets.APIGEE_ORG }}

      - name: Get latest revision
        id: get_rev
        run: |
          LATEST_REV=$(apigeecli apis revisions list \
            --org ${{ secrets.APIGEE_ORG }} \
            --name hello-world \
            --format json | jq -r 'max')
          echo "LATEST_REV=$LATEST_REV" >> $GITHUB_ENV
          echo "Latest revision: $LATEST_REV"

      - name: Deploy API Proxy
        run: |
          apigeecli apis deploy \
            --org ${{ secrets.APIGEE_ORG }} \
            --env ${{ secrets.APIGEE_ENV }} \
            --name hello-world \
            --rev ${{ env.LATEST_REV }} \
            --default-token

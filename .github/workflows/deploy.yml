name: Apigee X CI/CD for KVMs, Target Servers, Shared flows and API Proxies

on:
  push:
    branches:
      - test
  workflow_dispatch:
    inputs:
      api_name:
        description: 'Apigee API Proxy Name (manual mode only)'
        required: false
        type: string

      revision:
        description: 'Apigee API Revision (manual mode only)'
        required: false
        type: string

      source_env:
        description: 'Source Apigee Environment (manual mode only)'
        required: false
        type: choice
        options:
          - dev
          - test
          - eval

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/1041995087153/locations/global/workloadIdentityPools/github-pool/providers/github
          service_account: apigee-deploy-sa@bamboo-zone-363116.iam.gserviceaccount.com

      - name: Determine execution mode
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.api_name }}" ]]; then
            echo "MODE=MANUAL" >> $GITHUB_ENV
          else
            echo "MODE=AUTO" >> $GITHUB_ENV
          fi

      - name: Set Apigee Environment
        run: |
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            echo "APIGEE_ENV=dev" >> $GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "test" ]]; then
            echo "APIGEE_ENV=eval" >> $GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "APIGEE_ENV=eval" >> $GITHUB_ENV
          else
            echo "Unsupported branch: ${{ github.ref_name }}"
            exit 1
          fi

      - name: Install apigeecli
        run: |
          curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh -o install_apigeecli.sh
          chmod +x install_apigeecli.sh
          ./install_apigeecli.sh
          echo "$HOME/.apigeecli/bin" >> $GITHUB_PATH

# ===========================
# AUTO MODE (existing behavior)
# ===========================

      - name: Deploy KVMs
        if: env.MODE == 'AUTO'
        run: |
          if [ -d "configs/${{ env.APIGEE_ENV }}/kvms" ]; then
            for file in configs/${{ env.APIGEE_ENV }}/kvms/*.json; do
              [ -e "$file" ] || continue
              KVM_NAME=$(basename "$file" .json)
              apigeecli kvms create \
                --org "${{ secrets.APIGEE_ORG }}" \
                --env "${{ env.APIGEE_ENV }}" \
                --name "$KVM_NAME" \
                --default-token || true
              apigeecli kvms entries import \
                --org "${{ secrets.APIGEE_ORG }}" \
                --env "${{ env.APIGEE_ENV }}" \
                --map "$KVM_NAME" \
                -f "$file" \
                --default-token
            done
          fi

      - name: Deploy Modified Target Servers
        if: env.MODE == 'AUTO'
        run: |
          MODIFIED_TS=$(git diff --name-only HEAD^ HEAD | grep "^configs/${{ env.APIGEE_ENV }}/target-servers/" || true)
          for file in $MODIFIED_TS; do
            apigeecli targetservers import \
              --org "${{ secrets.APIGEE_ORG }}" \
              --env "${{ env.APIGEE_ENV }}" \
              -f "$file" \
              --default-token
          done

      - name: Deploy Modified Shared Flows
        if: env.MODE == 'AUTO'
        run: |
          MODIFIED_SFS=$(git diff --name-only HEAD^ HEAD | grep "^sharedflows/" | cut -d/ -f2 | sort -u || true)
          for SF in $MODIFIED_SFS; do
            apigeecli sharedflows create bundle \
              --name "$SF" \
              --sf-folder "sharedflows/$SF/sharedflowbundle" \
              --org "${{ secrets.APIGEE_ORG }}" \
              --default-token
            apigeecli sharedflows deploy \
              --name "$SF" \
              --org "${{ secrets.APIGEE_ORG }}" \
              --env "${{ env.APIGEE_ENV }}" \
              --ovr \
              --default-token
          done

      - name: Deploy Modified API Proxies
        if: env.MODE == 'AUTO'
        run: |
          MODIFIED_PROXIES=$(git diff --name-only HEAD^ HEAD | grep "^proxies/" | cut -d/ -f2 | sort -u || true)
          for API in $MODIFIED_PROXIES; do
            apigeecli apis create bundle \
              --name "$API" \
              --proxy-folder "proxies/$API/apiproxy" \
              --org "${{ secrets.APIGEE_ORG }}" \
              --default-token
            apigeecli apis deploy \
              --name "$API" \
              --org "${{ secrets.APIGEE_ORG }}" \
              --env "${{ env.APIGEE_ENV }}" \
              --ovr \
              --default-token
          done

# ===========================
# MANUAL MODE (UI-driven)
# ===========================

      - name: Export API from Apigee
        if: env.MODE == 'MANUAL'
        run: |
          API="${{ github.event.inputs.api_name }}"
          REV="${{ github.event.inputs.revision }}"

          mkdir -p proxies/$API
          apigeecli apis fetch \
            --org "${{ secrets.APIGEE_ORG }}" \
            -n "$API" \
            -v "$REV" \
             --default-token \
             --file proxies/$API/apiproxy.zip

          # Unzip the downloaded bundle
          unzip -o proxies/$API/apiproxy.zip -d proxies/$API/apiproxy
          ls -la proxies/$API/apiproxy

      - name: Commit exported API to Git
        if: env.MODE == 'MANUAL'
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git add proxies/${{ github.event.inputs.api_name }}
          git commit -m "Export Apigee API ${{
            github.event.inputs.api_name }} rev ${{
            github.event.inputs.revision }} from ${{
            github.event.inputs.source_env }}" || echo "No changes"
          git push origin main

      - name: Deploy API to Apigee (Manual)
        if: env.MODE == 'MANUAL'
        run: |
          API="${{ github.event.inputs.api_name }}"

          apigeecli apis create bundle \
            --name "$API" \
            --proxy-folder "proxies/$API/apiproxy" \
            --org "${{ secrets.APIGEE_ORG }}" \
            --default-token

          apigeecli apis deploy \
            --name "$API" \
            --org "${{ secrets.APIGEE_ORG }}" \
            --env "${{ env.APIGEE_ENV }}" \
            --ovr \
            --default-token

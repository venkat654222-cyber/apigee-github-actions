name: Apigee X CI/CD (Industry Standard)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Allows manual full deployment if needed

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # üü¢ REQUIRED for Workload Identity Federation

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # üü¢ REQUIRED to detect modified files via git diff

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          # Using your generated WIF Provider and Service Account
          workload_identity_provider: 'projects/1041995087153/locations/global/workloadIdentityPools/github-pool/providers/github'
          service_account: 'apigee-deploy-sa@bamboo-zone-363116.iam.gserviceaccount.com'

      - name: Install apigeecli
        run: |
            # 1. Download the installer to a file
            curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh -o install_apigeecli.sh
            
            # 2. Check if the file was downloaded successfully and is not empty
            if [ -s install_apigeecli.sh ]; then
              chmod +x install_apigeecli.sh
              ./install_apigeecli.sh
              
              # 3. Add to GITHUB_PATH for subsequent steps
              echo "$HOME/.apigeecli/bin" >> $GITHUB_PATH
            else
              echo "Error: apigeecli installer download failed or file is empty."
              exit 1
            fi

      # 1Ô∏è‚É£ Manage Environment Configs (KVMs)
      # Scans configs/kvms/*.json and syncs them
      - name: Deploy KVMs
        run: |
          if [ -d "configs/kvms" ]; then
            for file in configs/kvms/*.json; do
              KVM_NAME=$(basename "$file" .json)
              echo "Processing KVM: $KVM_NAME"
              # Create KVM if not exists
              apigeecli kvms create --org ${{ secrets.APIGEE_ORG }} --env ${{ secrets.APIGEE_ENV }} \
                --name "$KVM_NAME" --default-token || true
              # Import entries from JSON file
              apigeecli kvms entries import --org ${{ secrets.APIGEE_ORG }} --env ${{ secrets.APIGEE_ENV }} \
                --map "$KVM_NAME" -f "$file" --default-token
            done
          fi

      # 2Ô∏è‚É£ Deploy Modified Shared Flows (Direct Folder)
      - name: Deploy Modified Shared Flows
        run: |
          MODIFIED_SFS=$(git diff --name-only HEAD^ HEAD | grep '^sharedflows/' | cut -d/ -f2 | sort -u || true)
          for SF_NAME in $MODIFIED_SFS; do
           # Check if the sharedflowbundle directory exists
           if [ -d "sharedflows/$SF_NAME/sharedflowbundle" ]; then
             echo "Creating and Deploying Shared Flow: $SF_NAME"
             
             # Use --sf-folder to point directly to the sharedflowbundle directory
             apigeecli sharedflows create bundle \
               --name "$SF_NAME" \
               --sf-folder "sharedflows/$SF_NAME/sharedflowbundle" \
               --org ${{ secrets.APIGEE_ORG }} \
               --default-token
             
             # Deploy the latest revision
             apigeecli sharedflows deploy \
               --name "$SF_NAME" \
               --org ${{ secrets.APIGEE_ORG }} \
               --env ${{ secrets.APIGEE_ENV }} \
               --ovr --default-token
           fi
          done

      - name: Deploy Modified API Proxies
        run: |
          MODIFIED_PROXIES=$(git diff --name-only HEAD^ HEAD | grep '^proxies/' | cut -d/ -f2 | sort -u || true)
            
            for PROXY_NAME in $MODIFIED_PROXIES; do
              # Check if the apiproxy directory exists
              if [ -d "proxies/$PROXY_NAME/apiproxy" ]; then
                echo "üöÄ Creating and Deploying Proxy: $PROXY_NAME"
                
                # Standard Fix: Point to the folder that CONTAINS the apiproxy directory
                # For many apigeecli versions, this is proxies/$PROXY_NAME/
                apigeecli apis create bundle \
                  --name "$PROXY_NAME" \
                  --proxy-folder "proxies/$PROXY_NAME/apiproxy" \
                  --org ${{ secrets.APIGEE_ORG }} \
                  --default-token
                
                # Deploy the latest revision
                apigeecli apis deploy \
                  --name "$PROXY_NAME" \
                  --org ${{ secrets.APIGEE_ORG }} \
                  --env ${{ secrets.APIGEE_ENV }} \
                  --ovr --default-token
              fi
            done
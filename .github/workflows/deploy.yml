name: Apigee X CI/CD (Industry Standard)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Allows manual full deployment if needed

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # üü¢ REQUIRED for Workload Identity Federation

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # üü¢ REQUIRED to detect modified files via git diff

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          # Using your generated WIF Provider and Service Account
          workload_identity_provider: 'projects/1041995087153/locations/global/workloadIdentityPools/github-pool/providers/github'
          service_account: 'apigee-deploy-sa@bamboo-zone-363116.iam.gserviceaccount.com'

          - name: Install apigeecli
          run: |
            # 1. Download the installer to a file
            curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh -o install_apigeecli.sh
            
            # 2. Check if the file was downloaded successfully and is not empty
            if [ -s install_apigeecli.sh ]; then
              chmod +x install_apigeecli.sh
              ./install_apigeecli.sh
              
              # 3. Add to GITHUB_PATH for subsequent steps
              echo "$HOME/.apigeecli/bin" >> $GITHUB_PATH
            else
              echo "Error: apigeecli installer download failed or file is empty."
              exit 1
            fi

      # 1Ô∏è‚É£ Manage Environment Configs (KVMs)
      # Scans configs/kvms/*.json and syncs them
      - name: Deploy KVMs
        run: |
          if [ -d "configs/kvms" ]; then
            for file in configs/kvms/*.json; do
              KVM_NAME=$(basename "$file" .json)
              echo "Processing KVM: $KVM_NAME"
              # Create KVM if not exists
              apigeecli kvms create --org ${{ secrets.APIGEE_ORG }} --env ${{ secrets.APIGEE_ENV }} \
                --name "$KVM_NAME" --default-token || true
              # Import entries from JSON file
              apigeecli kvms entries import --org ${{ secrets.APIGEE_ORG }} --env ${{ secrets.APIGEE_ENV }} \
                --map "$KVM_NAME" -f "$file" --default-token
            done
          fi

      # 2Ô∏è‚É£ Deploy Modified Shared Flows (Must be before Proxies)
      - name: Deploy Modified Shared Flows
        run: |
          mkdir -p sf-bundles
          # Detect modified Shared Flows in this commit
          MODIFIED_SFS=$(git diff --name-only HEAD^ HEAD | grep '^sharedflows/' | cut -d/ -f2 | sort -u || true)
          
          if [ -n "$MODIFIED_SFS" ]; then
            for SF_NAME in $MODIFIED_SFS; do
              if [ -d "sharedflows/$SF_NAME/sharedflowbundle" ]; then
                echo "Updating Shared Flow: $SF_NAME"
                cd "sharedflows/$SF_NAME" && zip -r "../../sf-bundles/$SF_NAME.zip" sharedflowbundle && cd ../..
                apigeecli sharedflows import --org ${{ secrets.APIGEE_ORG }} --name "$SF_NAME" -p "sf-bundles/$SF_NAME.zip" --default-token
                apigeecli sharedflows deploy --org ${{ secrets.APIGEE_ORG }} --env ${{ secrets.APIGEE_ENV }} --name "$SF_NAME" --ovr --default-token
              fi
            done
          else
            echo "No Shared Flows modified."
          fi

      # 3Ô∏è‚É£ Deploy Modified API Proxies
      - name: Deploy Modified API Proxies
        run: |
          mkdir -p proxy-bundles
          # Detect modified Proxies in this commit
          MODIFIED_PROXIES=$(git diff --name-only HEAD^ HEAD | grep '^proxies/' | cut -d/ -f2 | sort -u || true)
          
          if [ -n "$MODIFIED_PROXIES" ]; then
            for PROXY_NAME in $MODIFIED_PROXIES; do
              if [ -d "proxies/$PROXY_NAME/apiproxy" ]; then
                echo "Updating Proxy: $PROXY_NAME"
                cd "proxies/$PROXY_NAME" && zip -r "../../proxy-bundles/$PROXY_NAME.zip" apiproxy && cd ../..
                apigeecli apis import --org ${{ secrets.APIGEE_ORG }} --name "$PROXY_NAME" -p "proxy-bundles/$PROXY_NAME.zip" --default-token
                apigeecli apis deploy --org ${{ secrets.APIGEE_ORG }} --env ${{ secrets.APIGEE_ENV }} --name "$PROXY_NAME" --ovr --default-token
              fi
            done
          else
            echo "No API Proxies modified."
          fi